-------------------------------------------------------------
-- AZULES: ESTRUCTURA Y RESTRICCIONES DECLARATIVAS
-------------------------------------------------------------

--------------------------
-- TABLAS
--------------------------

CREATE TABLE Usuarios (
id_usuario INT NOT NULL,
nombre VARCHAR2(150) NOT NULL,
correo VARCHAR2(150) NOT NULL,
contrasena VARCHAR2(200) NOT NULL,
rol VARCHAR2(30) NOT NULL
);

CREATE TABLE Estudiantes (
id_estudiante INT NOT NULL,
id_usuario INT NOT NULL,
carrera VARCHAR2(100) NOT NULL,
semestre INT NOT NULL
);

CREATE TABLE Tutores (
id_tutor INT NOT NULL,
id_usuario INT NOT NULL,
experiencia VARCHAR2(200) NOT NULL,
tarifa_hora NUMBER(10,2) NOT NULL,
calificacion_promedio NUMBER(5,2) NOT NULL
);

CREATE TABLE Disponibilidades (
id_disponibilidad INT NOT NULL,
id_tutor INT NOT NULL,
fecha DATE NOT NULL,
hora_inicio DATE NOT NULL,
hora_fin DATE NOT NULL,
estado VARCHAR2(20) NOT NULL 
);

CREATE TABLE Especialidades (
id_especialidad INT NOT NULL,
nombre VARCHAR2(120) NOT NULL,
descripcion VARCHAR2(300) NOT NULL
);

CREATE TABLE Materias (
id_materia INT NOT NULL,
nombre VARCHAR2(120) NOT NULL,
id_especialidad INT NOT NULL
);

CREATE TABLE Reservas (
id_reserva INT NOT NULL,
id_estudiante INT NOT NULL,
id_tutor INT NOT NULL,
id_materia INT NOT NULL,
fecha_reserva DATE NOT NULL,
estado VARCHAR2(20) NOT NULL
);

CREATE TABLE Sesiones (
id_sesion INT NOT NULL,
id_reserva INT NOT NULL,
fecha_inicio DATE NOT NULL,
fecha_fin DATE NOT NULL,
estado VARCHAR2(20) NOT NULL
);

CREATE TABLE Pagos (
id_pago INT NOT NULL,
id_sesion INT NOT NULL,
monto NUMBER(12,2) NOT NULL,
fecha_pago DATE NOT NULL,
estado VARCHAR2(20) NOT NULL
);

CREATE TABLE Resenias (
id_resenia INT NOT NULL,
id_reserva INT NOT NULL,
calificacion NUMBER(3,1) NOT NULL,
comentario VARCHAR2(500) NOT NULL,
fecha_resenia DATE NOT NULL
);

--------------------------
-- RESTRICCIONES 
--------------------------

-- PRIMARY KEYS

ALTER TABLE Usuarios
ADD CONSTRAINT pk_usuario PRIMARY KEY (id_usuario);

ALTER TABLE Estudiantes    
ADD CONSTRAINT pk_estudiante PRIMARY KEY (id_estudiante);

ALTER TABLE Tutores   
ADD CONSTRAINT pk_tutor PRIMARY KEY (id_tutor);

ALTER TABLE Disponibilidades 
ADD CONSTRAINT pk_disponibilidad PRIMARY KEY (id_disponibilidad);

ALTER TABLE Especialidades
ADD CONSTRAINT pk_especialidad PRIMARY KEY (id_especialidad);

ALTER TABLE Materias
ADD CONSTRAINT pk_materia PRIMARY KEY (id_materia);

ALTER TABLE Reservas      
ADD CONSTRAINT pk_reserva PRIMARY KEY (id_reserva);

ALTER TABLE Sesiones      
ADD CONSTRAINT pk_sesion PRIMARY KEY (id_sesion);

ALTER TABLE Pagos      
ADD CONSTRAINT pk_pago PRIMARY KEY (id_pago);

ALTER TABLE Resenias       
ADD CONSTRAINT pk_resenia PRIMARY KEY (id_resenia);

-- UNIQUE

ALTER TABLE Usuarios
ADD CONSTRAINT uq_usuario_correo UNIQUE (correo);


-- FOREIGN KEYS

ALTER TABLE Estudiantes
ADD CONSTRAINT fk_estudiante_usuario FOREIGN KEY (id_usuario)
REFERENCES Usuario (id_usuario);

ALTER TABLE Tutores
ADD CONSTRAINT fk_tutor_usuario FOREIGN KEY (id_usuario)
REFERENCES Usuario (id_usuario);

ALTER TABLE Disponibilidades
ADD CONSTRAINT fk_disponibilidad_tutor FOREIGN KEY (id_tutor)
REFERENCES Tutor (id_tutor);

ALTER TABLE Materias
ADD CONSTRAINT fk_materia_especialidad FOREIGN KEY (id_especialidad)
REFERENCES Especialidad (id_especialidad);

ALTER TABLE Reservas
ADD CONSTRAINT fk_reserva_estudiante FOREIGN KEY (id_estudiante)
REFERENCES Estudiante (id_estudiante);

ALTER TABLE Reservas
ADD CONSTRAINT fk_reserva_tutor FOREIGN KEY (id_tutor)
REFERENCES Tutor (id_tutor);

ALTER TABLE Reservas
ADD CONSTRAINT fk_reserva_materia FOREIGN KEY (id_materia)
REFERENCES Materia (id_materia);

ALTER TABLE Sesiones
ADD CONSTRAINT fk_sesion_reserva FOREIGN KEY (id_reserva)
REFERENCES Reserva (id_reserva);

ALTER TABLE Pagos
ADD CONSTRAINT fk_pago_sesion FOREIGN KEY (id_sesion)
REFERENCES Sesion (id_sesion);

ALTER TABLE Resenias
ADD CONSTRAINT fk_resenia_reserva FOREIGN KEY (id_reserva)
REFERENCES Reserva (id_reserva);

-- CHECKs

ALTER TABLE Tutores
ADD CONSTRAINT ck_tutor_tarifa 
CHECK (tarifa_hora >= 0);

ALTER TABLE Tutores
ADD CONSTRAINT ck_tutor_calificacion 
CHECK (calificacion_promedio BETWEEN 0 AND 100);

ALTER TABLE Reservas
ADD CONSTRAINT ck_reserva_estado
CHECK (estado IN ('En espera', 'Confirmada', 'Cancelada', 'Finalizada'));

ALTER TABLE Sesiones
ADD CONSTRAINT ck_sesion_estado
CHECK (estado IN ('Programada','En curso','Finalizada','Cancelada'));

ALTER TABLE Pagos
ADD CONSTRAINT ck_pago_estado 
CHECK (estado IN ('En espera','Pagado','Fallido'));



-- Inserción de datos de ejemplo(10.000 datos por tabla)

-------------------------------------------------------------
-- 10.000 USUARIOS
-------------------------------------------------------------

DECLARE
BEGIN
    FOR i IN 1..10000 LOOP
        INSERT INTO USUARIOS (id_usuario, nombre, correo, contrasena, rol)
        VALUES (
            i,
            'Usuario ' || i,
            'usuario' || i || '@mail.com',
            'pass' || i,
            CASE 
                WHEN MOD(i, 2) = 0 THEN 'Estudiante'
                ELSE 'Tutor'
            END
        );
    END LOOP;
END;
/
-------------------------------------------------------------
-- 10.000 ESTUDIANTES (usuarios pares)
-------------------------------------------------------------
DECLARE
    v_id NUMBER := 2; 
BEGIN
    FOR i IN 1..10000 LOOP
        INSERT INTO ESTUDIANTES (id_estudiante, id_usuario, carrera, semestre)
        VALUES (
            i,
            v_id,
            'Carrera ' || MOD(i, 20),
            MOD(i, 10) + 1
        );
        v_id := v_id + 2;
    END LOOP;
END;
/
-------------------------------------------------------------
-- 10.000 TUTORES (usuarios impares)
-------------------------------------------------------------
DECLARE
    v_id NUMBER := 1;
BEGIN
    FOR i IN 1..10000 LOOP
        INSERT INTO TUTORES (id_tutor, id_usuario, experiencia, tarifa_hora, calificacion_promedio)
        VALUES (
            i,
            v_id,
            'Experiencia ' || i,
            MOD(i, 50) + 10,
            MOD(i, 5) * 10
        );
        v_id := v_id + 2;
    END LOOP;
END;
/
-------------------------------------------------------------
-- 10.000 ESPECIALIDADES
-------------------------------------------------------------
DECLARE
BEGIN
    FOR i IN 1..10000 LOOP
        INSERT INTO ESPECIALIDADES (id_especialidad, nombre, descripcion)
        VALUES (
            i,
            'Especialidad ' || i,
            'Descripcion de especialidad ' || i
        );
    END LOOP;
END;
/
-------------------------------------------------------------
-- 10.000 MATERIAS
-------------------------------------------------------------
DECLARE
BEGIN
    FOR i IN 1..10000 LOOP
        INSERT INTO MATERIAS (id_materia, nombre, id_especialidad)
        VALUES (
            i,
            'Materia ' || i,
            MOD(i, 10000) + 1
        );
    END LOOP;
END;
/
-------------------------------------------------------------
-- 10.000 RESERVAS
-------------------------------------------------------------
DECLARE
BEGIN
    FOR i IN 1..10000 LOOP
        INSERT INTO RESERVAS (id_reserva, id_estudiante, id_tutor, id_materia, fecha_reserva, estado)
        VALUES (
            i,
            MOD(i, 10000) + 1,
            MOD(i + 1, 10000) + 1,
            MOD(i + 2, 10000) + 1,
            SYSDATE - MOD(i, 365),
            'Confirmada'
        );
    END LOOP;
END;
/
-------------------------------------------------------------
-- 10.000 SESIONES
-------------------------------------------------------------
DECLARE
BEGIN
    FOR i IN 1..10000 LOOP
        INSERT INTO SESIONES (id_sesion, id_reserva, fecha_inicio, fecha_fin, estado)
        VALUES (
            i,
            MOD(i, 10000) + 1,
            SYSDATE - MOD(i, 365),
            SYSDATE - MOD(i, 365) + 1/24,
            'Finalizada'
        );
    END LOOP;
END;
/
-------------------------------------------------------------
-- 10.000 PAGOS
-------------------------------------------------------------
DECLARE
BEGIN
    FOR i IN 1..10000 LOOP
        INSERT INTO PAGOS (id_pago, id_sesion, monto, fecha_pago, estado)
        VALUES (
            i,
            MOD(i, 10000) + 1,
            MOD(i, 100) + 20,
            SYSDATE - MOD(i, 365),
            'Pagado'
        );
    END LOOP;
END;
/
-------------------------------------------------------------
-- 10.000 RESEÑAS
-------------------------------------------------------------
DECLARE
BEGIN
    FOR i IN 1..10000 LOOP
        INSERT INTO RESENIAS (id_resenia, id_reserva, calificacion, comentario, fecha_resenia)
        VALUES (
            i,
            MOD(i, 10000) + 1,
            MOD(i, 5) + 1,
            'Comentario ' || i,
            SYSDATE - MOD(i, 365)
        );
    END LOOP;
END;
/

COMMIT;




-- Eliminación de datos

DELETE FROM Resenias;
DELETE FROM Pagos;
DELETE FROM Sesiones;
DELETE FROM Reservas;
DELETE FROM Materias;
DELETE FROM Especialidades;
DELETE FROM Disponibilidades;
DELETE FROM Tutores;
DELETE FROM Estudiantes;
DELETE FROM Usuarios;

-- Eliminación de tablas en orden correcto

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE Resenia CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE Pago CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE Sesion CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE Reserva CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE Materia CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE Especialidad CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE Disponibilidad CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE Tutor CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE Estudiante CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE Usuario CASCADE CONSTRAINTS';
END;
/

-- Consulta SQL básica

SELECT nombre, correo, rol FROM Usuario;

-- Consulta con identificador

SELECT e.id_estudiante, u.nombre, u.correo
FROM Estudiante e
JOIN Usuario u ON e.id_estudiante = u.id_usuario;

-------------------------------------------------------------
--SECCIÓN VERDE: PROCEDIMENTALES Y PRUEBAS
-------------------------------------------------------------


-------------------------------------------------------------
-- TUPLAS
-------------------------------------------------------------

CREATE SEQUENCE seq_usuario START WITH 3 INCREMENT BY 1;
CREATE SEQUENCE seq_estudiante START WITH 2 INCREMENT BY 1;
CREATE SEQUENCE seq_tutor START WITH 2 INCREMENT BY 1;
CREATE SEQUENCE seq_disponibilidad START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE seq_especialidad START WITH 2 INCREMENT BY 1;
CREATE SEQUENCE seq_materia START WITH 2 INCREMENT BY 1;
CREATE SEQUENCE seq_reserva START WITH 2 INCREMENT BY 1;
CREATE SEQUENCE seq_sesion START WITH 2 INCREMENT BY 1;
CREATE SEQUENCE seq_pago START WITH 2 INCREMENT BY 1;
CREATE SEQUENCE seq_resenia START WITH 2 INCREMENT BY 1;


-------------------------------------------------------------
-- ACCIONES
-------------------------------------------------------------

-- Procedimiento para registrar usuarios

CREATE OR REPLACE PROCEDURE sp_registrar_usuario(
    p_nombre IN VARCHAR2,
    p_correo IN VARCHAR2,
    p_contrasena IN VARCHAR2,
    p_rol IN VARCHAR2
) AS
BEGIN
    INSERT INTO Usuario (id_usuario, nombre, correo, contrasena, rol)
    VALUES (seq_usuario.NEXTVAL, p_nombre, p_correo, p_contrasena, p_rol);
    COMMIT;
END;
/

-- Procedimiento para crear una reserva

CREATE OR REPLACE PROCEDURE sp_crear_reserva(
    p_id_estudiante IN INT,
    p_id_tutor IN INT,
    p_id_materia IN INT
) AS
BEGIN
    INSERT INTO Reserva (id_reserva, id_estudiante, id_tutor, id_materia, fecha_reserva, estado)
    VALUES (seq_reserva.NEXTVAL, p_id_estudiante, p_id_tutor, p_id_materia, SYSDATE, 'En espera');
    COMMIT;
END;
/

-- Función para calcular las ganancias totales de un tutor

CREATE OR REPLACE FUNCTION fn_ganancia_tutor(p_id_tutor INT)
RETURN NUMBER IS
    v_total NUMBER;
BEGIN
    SELECT NVL(SUM(p.monto), 0)
    INTO v_total
    FROM Pago p
    JOIN Sesion s ON p.id_sesion = s.id_sesion
    JOIN Reserva r ON s.id_reserva = r.id_reserva
    WHERE r.id_tutor = p_id_tutor;
    RETURN v_total;
END;
/

-------------------------------------------------------------
-- DISPARADORES
-------------------------------------------------------------

-- Trigger para asignar ID automático a usuarios

CREATE OR REPLACE TRIGGER trg_usuario_autoinc
BEFORE INSERT ON Usuario
FOR EACH ROW
BEGIN
    :NEW.id_usuario := seq_usuario.NEXTVAL;
END;
/

-- Trigger para asignar ID automático a estudiantes

CREATE OR REPLACE TRIGGER trg_estudiante_autoinc
BEFORE INSERT ON Estudiante
FOR EACH ROW
BEGIN
    :NEW.id_estudiante := seq_estudiante.NEXTVAL;
END;
/

-- Trigger para asignar ID automático a tutores

CREATE OR REPLACE TRIGGER trg_tutor_autoinc
BEFORE INSERT ON Tutor
FOR EACH ROW
BEGIN
    :NEW.id_tutor := seq_tutor.NEXTVAL;
END;
/

-- Trigger que impide eliminar usuarios con reservas activas

CREATE OR REPLACE TRIGGER trg_no_borrar_con_reservas
BEFORE DELETE ON Usuario
FOR EACH ROW
DECLARE
    v_count INT;
BEGIN
    SELECT COUNT(*) INTO v_count
    FROM Reserva r
    JOIN Estudiante e ON r.id_estudiante = e.id_estudiante
    WHERE e.id_usuario = :OLD.id_usuario;

    IF v_count > 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'No se puede eliminar el usuario: tiene reservas asociadas.');
    END IF;
END;
/

-------------------------------------------------------------
-- TUPLASOK
-- (Inserciones válidas)
-------------------------------------------------------------

INSERT INTO Usuario VALUES (3, 'Carlos Ruiz', 'carlos@correo.com', 'abc123', 'E');
INSERT INTO Estudiante VALUES (2, 3, 'Ingeniería Electrónica', 3);
INSERT INTO Tutor VALUES (2, 2, '5 años de experiencia en física', 80000, 95);
INSERT INTO Materia VALUES (2, 'Álgebra Lineal', 1);
INSERT INTO Reserva VALUES (2, 1, 2, 2, SYSDATE, 'En espera');
INSERT INTO Sesion VALUES (2, 2, SYSDATE, SYSDATE + 1/24, 'Programada');
INSERT INTO Pago VALUES (2, 2, 80000, SYSDATE, 'Pagado');
INSERT INTO Resenia VALUES (2, 2, 100, 'Muy buena clase', SYSDATE);
COMMIT;

-------------------------------------------------------------
-- TUPLASNOOK
-- (Inserciones inválidas que deben generar error)
-------------------------------------------------------------

-- Intentar insertar un correo duplicado

INSERT INTO Usuario VALUES (4, 'Pedro', 'carlos@correo.com', 'pass', 'E');

-- Intentar insertar un tutor con tarifa negativa

INSERT INTO Tutor VALUES (3, 2, 'Sin experiencia', -10000, 80);

-- Intentar insertar una reserva con estado no válido

INSERT INTO Reserva VALUES (3, 1, 1, 1, SYSDATE, 'Pendiente');


-------------------------------------------------------------
-- ACCIONESOK
-- (Ejecución de procedimientos válidos)
-------------------------------------------------------------

BEGIN
    sp_registrar_usuario('Ana Torres', 'ana@correo.com', 'clave', 'T');
END;
/

BEGIN
    sp_crear_reserva(1, 1, 1);
END;
/

SELECT fn_ganancia_tutor(1) AS GananciaTutor FROM DUAL;


-------------------------------------------------------------
-- DISPARADORESOK
-- (Comprobación de triggers activos)
-------------------------------------------------------------

-- Insertar nuevo usuario y verificar autoincremento

INSERT INTO Usuario (nombre, correo, contrasena, rol)
VALUES ('Miguel Ángel', 'miguel@correo.com', 'xyz', 'E');

-- Eliminar usuario sin reservas (debe funcionar)

DELETE FROM Usuario WHERE correo = 'miguel@correo.com';
COMMIT;

-------------------------------------------------------------
-- DISPARADORESNOOK
-------------------------------------------------------------

-- Intentar eliminar usuario con reservas activas

DELETE FROM Usuario WHERE id_usuario = 1;

-- Intentar insertar un tutor con tarifa excesiva (trigger experimental)

ALTER TRIGGER trg_validar_tarifa ENABLE;
INSERT INTO Tutor VALUES (5, 2, 'Experto en programación', 300000, 90);
ALTER TRIGGER trg_validar_tarifa DISABLE;

-------------------------------------------------------------
-- XDISPARADORES
-- (Eliminación de triggers existentes)
-------------------------------------------------------------

BEGIN
    EXECUTE IMMEDIATE 'DROP TRIGGER trg_usuario_autoinc';
    EXECUTE IMMEDIATE 'DROP TRIGGER trg_estudiante_autoinc';
    EXECUTE IMMEDIATE 'DROP TRIGGER trg_tutor_autoinc';
    EXECUTE IMMEDIATE 'DROP TRIGGER trg_no_borrar_con_reservas';
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Algunos triggers no existían o ya fueron eliminados.');
END;
/
